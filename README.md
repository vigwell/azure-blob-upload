# Azure Blob Storage Chunked Upload

Node.js –ø—Ä–æ–µ–∫—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤ –ø–æ —á–∞—Å—Ç—è–º –≤ Azure Blob Storage.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
npm install
```

### 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤
–ü–æ–º–µ—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞:
- `sample_video.webm` - –≤–∏–¥–µ–æ —Ñ–∞–π–ª
- `sample_audio.webm` - –∞—É–¥–∏–æ —Ñ–∞–π–ª

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –∏–∑ –ø—Ä–∏–º–µ—Ä–∞:
```bash
npm run env:create
```

–ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é:
```bash
# –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
IS_DEBUG=true

# URL –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞) 
DEBUG_URL=https://localhost:7000/api

# URL –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
REAL_URL=https://api.production.com/api

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
CHUNK_SIZE=4194304
REQUEST_TIMEOUT=30000
MAX_RETRIES=3

# –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
COMPANY_ID=3fa85f64-5717-4562-b3fc-2c963f66afa6
SESSION_ID=3fa85f64-5717-4562-b3fc-2c963f66afa6
```

### 4. –ó–∞–ø—É—Å–∫
```bash
npm start
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
azure-blob-chunked-upload/
‚îú‚îÄ‚îÄ package.json          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ upload.js             # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∑–∫–∏
‚îú‚îÄ‚îÄ README.md            # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ sample_video.webm    # –¢–µ—Å—Ç–æ–≤—ã–π –≤–∏–¥–µ–æ —Ñ–∞–π–ª (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å)
‚îî‚îÄ‚îÄ sample_audio.webm    # –¢–µ—Å—Ç–æ–≤—ã–π –∞—É–¥–∏–æ —Ñ–∞–π–ª (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å)
```

## ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

### **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
```bash
# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
npm run env:show

# –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º DEBUG ‚áÑ PRODUCTION
npm run env:toggle

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
npm run env:setup

# –°–æ–∑–¥–∞—Ç—å .env –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
npm run env:create

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
npm run env:validate
```

### **–ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã**
```bash
# –ó–∞–ø—É—Å–∫ –≤ debug —Ä–µ–∂–∏–º–µ
npm run debug

# –ó–∞–ø—É—Å–∫ –≤ production —Ä–µ–∂–∏–º–µ  
npm run prod

# –û–±—ã—á–Ω—ã–π –∑–∞–ø—É—Å–∫ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç IS_DEBUG –∏–∑ .env)
npm start
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### **–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (.env —Ñ–∞–π–ª):**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|----------|----------|--------------|
| `IS_DEBUG` | –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ (true/false) | `true` |
| `DEBUG_URL` | URL –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ | `https://localhost:7000/api` |
| `REAL_URL` | URL –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ | `https://api.production.com/api` |
| `CHUNK_SIZE` | –†–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏ —Ñ–∞–π–ª–∞ (–±–∞–π—Ç—ã) | `4194304` (4MB) |
| `REQUEST_TIMEOUT` | –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (–º—Å) | `30000` |
| `MAX_RETRIES` | –ú–∞–∫—Å–∏–º—É–º –ø–æ–≤—Ç–æ—Ä–æ–≤ | `3` |
| `COMPANY_ID` | ID –∫–æ–º–ø–∞–Ω–∏–∏ | `3fa85f64-5717-4562-b3fc-2c963f66afa6` |
| `SESSION_ID` | ID —Å–µ—Å—Å–∏–∏ | `3fa85f64-5717-4562-b3fc-2c963f66afa6` |
| `OVERLAY_TEXT` | –¢–µ–∫—Å—Ç –¥–ª—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –≤–∏–¥–µ–æ | `Processing Video...` |

### **–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:**

**üîß DEBUG —Ä–µ–∂–∏–º** (`IS_DEBUG=true`):
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `DEBUG_URL` 
- –û—Ç–∫–ª—é—á–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**üè≠ PRODUCTION —Ä–µ–∂–∏–º** (`IS_DEBUG=false`):
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `REAL_URL`
- –í–∫–ª—é—á–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°–∫—Ä—ã—Ç–∞ –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. **–ü–æ–ª—É—á–µ–Ω–∏–µ SAS —Ç–æ–∫–µ–Ω–æ–≤**
```bash
curl -X 'POST' \
  'https://localhost:7000/api/Video/sas' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
    "companyIdFromUserToken": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "sessionId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "streamId": "string"
  }'
```

### 2. **–û—Ç–≤–µ—Ç API**
```json
{
  "success": true,
  "payload": {
    "videoSasUrl": "https://rads4vets.blob.core.windows.net/video-raw-uploads/string/20250917091611_video.webm?sv=...",
    "audioSasUrl": "https://rads4vets.blob.core.windows.net/video-raw-uploads/string/20250917091611_audio.webm?sv=...",
    "blobPrefix": "string/20250917091611"
  }
}
```

### 3. **–ê–ª–≥–æ—Ä–∏—Ç–º –∑–∞–≥—Ä—É–∑–∫–∏**

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞** –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ 4MB
2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Block ID** –¥–ª—è –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏
3. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞** —á–∞—Å—Ç–µ–π —á–µ—Ä–µ–∑ `PUT Block` API
4. **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ** —á–∞—Å—Ç–µ–π —á–µ—Ä–µ–∑ `PUT Block List` API
5. **–í—ã–∑–æ–≤ finalize API** –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ FFmpeg
6. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### 4. **–ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ SAS —Ç–æ–∫–µ–Ω–æ–≤** (`/api/Video/sas`)
2. **Chunked upload** –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤
3. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏** (`/api/Video/finalize`)
4. **–ó–∞–ø—É—Å–∫ FFmpeg –æ–±—Ä–∞–±–æ—Ç–∫–∏** —á–µ—Ä–µ–∑ Azure Storage Queue
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ "ready"**

## üìä –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```bash
üé¨ Azure Blob Storage Chunked Upload
=====================================
‚öôÔ∏è  –†–µ–∂–∏–º: üîß DEBUG
üåê API URL: https://localhost:7000/api
üì¶ –†–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏: 4 MB
‚è±Ô∏è  –¢–∞–π–º–∞—É—Ç: 30000ms

üìÅ –ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã:
   ./sample_video.webm (2.1 MB)
   ./sample_audio.webm (445.2 KB)

üîë –ü–æ–ª—É—á–∞–µ–º SAS —Ç–æ–∫–µ–Ω—ã... (DEBUG —Ä–µ–∂–∏–º)
üåê API URL: https://localhost:7000/api
‚úÖ SAS —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
üìÅ –ü—Ä–µ—Ñ–∏–∫—Å –±–ª–æ–±–∞: stream-1726564571000/20250917091611
üîç DEBUG: SAS URLs –ø–æ–ª—É—á–µ–Ω—ã (—Å–∫—Ä—ã—Ç—ã –≤ production)

üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤...
üì§ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É video.webm...
üìä –§–∞–π–ª: 2201472 –±–∞–π—Ç, 1 —á–∞—Å—Ç–µ–π
üöÄ –ó–∞–≥—Ä—É–∂–∞–µ–º 1 —á–∞—Å—Ç–µ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ...
üì¶ video.webm: 1/1 —á–∞—Å—Ç–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–æ
üîó –û–±—ä–µ–¥–∏–Ω—è–µ–º —á–∞—Å—Ç–∏ video.webm...
‚úÖ video.webm —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!

üéâ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
=====================
‚è±Ô∏è  –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: 2.34 —Å–µ–∫—É–Ω–¥
üìπ –í–∏–¥–µ–æ URL: https://rads4vets.blob.core.windows.net/...
üéµ –ê—É–¥–∏–æ URL: https://rads4vets.blob.core.windows.net/...
üìÇ –ü—Ä–µ—Ñ–∏–∫—Å: stream-1726564571000/20250917091611
üîß –†–µ–∂–∏–º: DEBUG

üé¨ –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ FFmpeg...
üèÅ –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É...
‚úÖ –ó–∞–¥–∞—á–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—É—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
üé¨ –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: final_stream-1726564571000.mp4
üìù –¢–µ–∫—Å—Ç –Ω–∞–ª–æ–∂–µ–Ω–∏—è: Patient ID: 12345
üîç DEBUG: SAS URLs –ø–æ–ª—É—á–µ–Ω—ã (—Å–∫—Ä—ã—Ç—ã –≤ production)

‚ú® –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω! –§–∞–π–ª—ã –ø–µ—Ä–µ–¥–∞–Ω—ã –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É.
üì∫ FFmpeg worker –Ω–∞—á–Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.

ready
```

## üõ†Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### **ChunkedUploader –∫–ª–∞—Å—Å**
- –†–∞–∑–¥–µ–ª—è–µ—Ç —Ñ–∞–π–ª –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ 4MB
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ Block ID –≤ —Ñ–æ—Ä–º–∞—Ç–µ base64
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç —á–∞—Å—Ç–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Azure Blob Storage Put Block API
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —á–∞—Å—Ç–∏ —á–µ—Ä–µ–∑ Put Block List API

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ API
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–∞—Å—Ç–µ–π —Ñ–∞–π–ª–∞
- –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —á–∞—Å—Ç–µ–π (4MB)
- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏

## üîç –û—Ç–ª–∞–¥–∫–∞

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ API**
```bash
# –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
curl -k https://localhost:7000/api/Video/sas

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
curl -v -k -X POST https://localhost:7000/api/Video/sas \
  -H "Content-Type: application/json" \
  -d '{"companyIdFromUserToken":"3fa85f64-5717-4562-b3fc-2c963f66afa6","sessionId":"3fa85f64-5717-4562-b3fc-2c963f66afa6","streamId":"test"}'
```

### **–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏**
- `ECONNREFUSED` - API —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω
- `ENOTFOUND` - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL API
- `404` - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint API
- `–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω` - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **axios** - HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
- **fs** - –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
- **path** - –†–∞–±–æ—Ç–∞ —Å –ø—É—Ç—è–º–∏ —Ñ–∞–π–ª–æ–≤
- **crypto** - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Block ID

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- [Azure Blob Storage Put Block API](https://docs.microsoft.com/en-us/rest/api/storageservices/put-block)
- [Azure Blob Storage Put Block List API](https://docs.microsoft.com/en-us/rest/api/storageservices/put-block-list)
- [Shared Access Signatures (SAS)](https://docs.microsoft.com/en-us/azure/storage/common/storage-sas-overview)